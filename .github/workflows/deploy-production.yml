name: Deploy to Cloudflare Workers (Production)

on:
  push:
    branches: [main]
  workflow_dispatch:  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨±å¯

jobs:
  test:
    name: Test & Build Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate knowledge data
        run: npm run generate:knowledge

      - name: Run type checking
        run: npx tsc --noEmit

      - name: Run tests
        run: npm test

      - name: Build for Workers
        run: npm run build:workers

      - name: Verify Workers build output
        run: |
          if [ ! -f build/workers/index.js ]; then
            echo "âŒ Error: build/workers/index.js not found"
            exit 1
          fi
          echo "âœ“ Workers build verification successful"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for Workers
        run: npm run build:workers

      - name: Configure wrangler.toml with KV Namespace IDs
        env:
          KV_NAMESPACE_ID: ${{ vars.KV_NAMESPACE_ID }}
          KV_NAMESPACE_PREVIEW_ID: ${{ vars.KV_NAMESPACE_PREVIEW_ID }}
        run: |
          # KV Namespace IDã‚’wrangler.tomlã«æ³¨å…¥
          sed -i.bak "s/__KV_NAMESPACE_ID__/${KV_NAMESPACE_ID}/g" wrangler.toml
          sed -i.bak "s/__KV_NAMESPACE_PREVIEW_ID__/${KV_NAMESPACE_PREVIEW_ID}/g" wrangler.toml
          echo "âœ“ KV Namespace IDs configured"

      - name: Deploy to Cloudflare Workers (Production)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env production

      - name: Set API Keys
        continue-on-error: true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          API_KEYS: ${{ secrets.API_KEYS }}
        run: |
          if [ -n "$API_KEYS" ]; then
            echo "Setting API keys for production environment..."
            echo "$API_KEYS" | npx wrangler secret put API_KEYS --env production
            echo "âœ“ API keys configured"
          else
            echo "âš  API_KEYS not set, skipping..."
          fi

      - name: Deployment Summary
        env:
          ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          echo "## ðŸŽ‰ Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${COMMIT_SHA}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** https://kkj-mcp-server-prod.${ACCOUNT_ID}.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- Health Check: \`/health\`" >> $GITHUB_STEP_SUMMARY
          echo "- MCP Endpoint: \`/mcp\`" >> $GITHUB_STEP_SUMMARY
